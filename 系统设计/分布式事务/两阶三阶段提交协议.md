## 2PC（Two-phaseCommit）

二阶段提交的算法思路可以概括为: 参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。

二阶段是指:  第一阶段：请求阶段(表决阶段)，第二阶段：提交阶段(执行阶段)

- 举个例子：

  > 结婚的时候会有如下对话:
  >
  > A:你愿意做他的丈夫吗
  >
  > B:我愿意
  >
  > A:你愿意做他妻子嘛
  >
  > C:我愿意
  >
  > A:我宣布你俩成为合法夫妻

  此时A两次询问，两人分别回应，但是只是表达自己意愿并不生效。A需要得到双方回答后宣布成为合法夫妻。


### 执行流程

#### 请求阶段（表决）：

事务协调者通知每个参与者准备提交或取消事务，然后进入表决过程，参与者要么在本地执行事务，写本地的redo和undo日志，但不提交，到达一种"万事俱备，只欠东风"的状态。请求阶段，参与者将告知协调者自己的决策: 同意(事务参与者本地作业执行成功)或取消（本地作业执行故障）

#### 提交阶段（执行）：

在该阶段，写调整将基于第一个阶段的投票结果进行决策: 提交或取消

当且仅当所有的参与者同意提交事务，协调者才通知所有的参与者提交事务，否则协调者将通知所有的参与者取消事务

参与者在接收到协调者发来的消息后将执行响应的操作

### 缺点及问题
- 同步阻塞问题。执行过程中，所有参与节点都是事务阻塞型的。
  当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态。

- 单点故障。由于协调者的重要性，一旦协调者发生故障。
  参与者会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。（如果是协调者挂掉，可以重新选举一个协调者，但是无法解决因为协调者宕机导致的参与者处于阻塞状态的问题）

- 数据不一致。在二阶段提交的阶段二中，当协调者向参与者发送commit请求之后，发生了局部网络异常或者在发送commit请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了commit请求。而在这部分参与者接到commit请求之后就会执行commit操作。但是其他部分未接到commit请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据不一致性的现象。



## 3PC（Three-phaseCommit）

### 执行流程

- **canCommit阶段**

  3PC的canCommit阶段其实和2PC的准备阶段很像。协调者向参与者发送commit请求，参与者如果可以提交就返回yes响应，否则返回no响应

- **preCommit阶段**

  协调者根据参与者canCommit阶段的响应来决定是否可以继续事务的preCommit操作。根据响应情况，有下面两种可能:

  **a) 协调者从所有参与者得到的反馈都是yes:**

  那么进行事务的预执行，协调者向所有参与者发送preCommit请求，并进入prepared阶段。参与泽和接收到preCommit请求后会执行事务操作，并将undo和redo信息记录到事务日志中。如果一个参与者成功地执行了事务操作，则返回ACK响应，同时开始等待最终指令

  **b)  协调者从所有参与者得到的反馈有一个是No或是等待超时之后协调者都没收到响应:**

  那么就要中断事务，协调者向所有的参与者发送abort请求。参与者在收到来自协调者的abort请求，或超时后仍未收到协调者请求，执行事务中断。

- **doCommit阶段**

  协调者根据参与者preCommit阶段的响应来决定是否可以继续事务的doCommit操作。根据响应情况，有下面两种可能:

  **a) 协调者从参与者得到了ACK的反馈:**

  协调者接收到参与者发送的ACK响应，那么它将从预提交状态进入到提交状态，并向所有参与者发送doCommit请求。参与者接收到doCommit请求后，执行正式的事务提交，并在完成事务提交之后释放所有事务资源，并向协调者发送haveCommitted的ACK响应。那么协调者收到这个ACK响应之后，完成任务。

  **b) 协调者从参与者没有得到ACK的反馈, 也可能是接收者发送的不是ACK响应，也可能是响应超时:**

  执行事务中断。

### 缺点

如果进入PreCommit后，Coordinator发出的是abort请求，假设只有一个Cohort收到并进行了abort操作，
而其他对于系统状态未知的Cohort会根据3PC选择继续Commit，此时系统状态发生不一致性。

## 对比

- 对于协调者(Coordinator)和参与者(Cohort)都设置了超时机制（在2PC中，只有协调者拥有超时机制，即如果在一定时间内没有收到cohort的消息则默认失败）。
- 在2PC的准备阶段和提交阶段之间，插入预提交阶段，使3PC拥有CanCommit、PreCommit、DoCommit三个阶段。
- PreCommit是一个缓冲，保证了在最后提交阶段之前各参与节点的状态是一致的。

> 除了两种阶段提交协议目前还有一种重要的算法就是Paxos算法，Zookeeper采用的就是Paxos算法的改进。